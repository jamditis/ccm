<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVOICER | Center for Cooperative Media</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Distinctive Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=IBM+Plex+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['"Syne"', 'sans-serif'],
                        'body': ['"Plus Jakarta Sans"', 'sans-serif'],
                        'serif': ['"Cormorant Garamond"', 'serif'],
                        'mono': ['"IBM Plex Mono"', 'monospace'],
                    },
                    colors: {
                        studio: {
                            900: '#0f0c29',
                            800: '#302b63',
                            700: '#24243e',
                            accent: '#f59e0b', // Amber
                            glass: 'rgba(255, 255, 255, 0.03)',
                            border: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #e2e8f0;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        /* Grain Texture Overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        #root { position: relative; z-index: 1; }

        /* Custom Input Styling */
        .input-group {
            position: relative;
            transition: all 0.3s ease;
        }
        .input-minimal {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .input-minimal:focus {
            background: rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.4);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.05);
        }
        .input-minimal::placeholder { color: rgba(255,255,255,0.3); }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* Print Overrides */
        @media print {
            @page { margin: 0; size: auto; }
            body { background: white; color: black; }
            body::before { display: none; }
            .no-print { display: none !important; }
            .print-container { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 100% !important; 
                max-width: 100% !important;
                border-radius: 0 !important;
            }
        }
        
        /* Mobile Inputs */
        @media screen and (max-width: 768px) {
            input, select, textarea { font-size: 16px !important; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- App Root -->
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- ICONS ---
        const IconDownload = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const IconPlus = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconTrash = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconSave = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const IconUser = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const IconPalette = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>;
        const IconEdit = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const IconEye = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const IconSparkle = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>;

        const InvoiceTool = () => {
            // --- STATE ---
            const [activeTab, setActiveTab] = useState('editor'); 
            const [meta, setMeta] = useState({
                number: 'INV-2025-001',
                dateIssued: new Date().toISOString().split('T')[0],
                dateDue: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                logo: null
            });

            const [sender, setSender] = useState({
                name: '',
                subtitle: 'Consulting & Speaker Services',
                address: '',
                email: '',
                phone: '',
                paymentInfo: ''
            });

            const [recipient, setRecipient] = useState({
                company: '',
                attn: '',
                address: ''
            });

            const [lineItems, setLineItems] = useState([
                { id: 1, description: 'Consulting Services', date: '', rate: 0, quantity: 1 }
            ]);

            const [notes, setNotes] = useState('Thank you for your business.');
            
            const [theme, setTheme] = useState({
                color: '#1e293b', 
                font: 'Plus Jakarta Sans',
                borderRadius: '0.125rem'
            });

            const [profiles, setProfiles] = useState([]);
            const [selectedProfile, setSelectedProfile] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);

            // --- EFFECTS ---
            useEffect(() => {
                const savedProfiles = localStorage.getItem('invoice_profiles');
                if (savedProfiles) {
                    setProfiles(JSON.parse(savedProfiles));
                }
                const handleResize = () => {
                    if (window.innerWidth >= 768) {
                        setActiveTab('split'); 
                    } else {
                        if (activeTab === 'split') setActiveTab('editor');
                    }
                };
                window.addEventListener('resize', handleResize);
                handleResize(); 
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // --- HANDLERS ---
            
            // Helper to determine text color based on background
            const getContrastColor = (hexcolor) => {
                // If invalid hex, return white (or default dark)
                if (!hexcolor || hexcolor.length < 7) return '#ffffff';
                
                const r = parseInt(hexcolor.substr(1, 2), 16);
                const g = parseInt(hexcolor.substr(3, 2), 16);
                const b = parseInt(hexcolor.substr(5, 2), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                
                // Returns dark slate for light backgrounds, white for dark
                return yiq >= 128 ? '#0f172a' : '#ffffff'; 
            };

            const handleLineItemChange = (id, field, value) => {
                setLineItems(items => items.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const addLineItem = () => {
                setLineItems([...lineItems, { id: Date.now(), description: '', date: '', rate: 0, quantity: 1 }]);
            };

            const removeLineItem = (id) => {
                if (lineItems.length > 1) {
                    setLineItems(items => items.filter(item => item.id !== id));
                }
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setMeta(prev => ({ ...prev, logo: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            const saveProfile = () => {
                const name = prompt("Profile Name (e.g., 'Joe's Consulting'):");
                if (!name) return;
                const newProfile = { id: Date.now(), name: name, data: { sender, notes, theme } };
                const updatedProfiles = [...profiles, newProfile];
                setProfiles(updatedProfiles);
                localStorage.setItem('invoice_profiles', JSON.stringify(updatedProfiles));
                setSelectedProfile(newProfile.id);
            };

            const loadProfile = (profileId) => {
                setSelectedProfile(profileId);
                if (!profileId) return;
                const profile = profiles.find(p => p.id === Number(profileId));
                if (profile) {
                    setSender(profile.data.sender);
                    setNotes(profile.data.notes);
                    if (profile.data.theme) setTheme(profile.data.theme);
                }
            };

            const calculateTotal = () => lineItems.reduce((acc, item) => acc + (item.rate * item.quantity), 0);

            const handleDownload = () => {
                setIsGenerating(true);
                const element = document.getElementById('invoice-preview-content');
                const originalOverflow = element.style.overflow;
                
                // Ensure content fits and radius is preserved
                element.style.overflow = 'visible';

                const opt = {
                    margin: 0.5,
                    filename: `Invoice_${meta.number}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false, 
                        scrollY: 0,
                        backgroundColor: null // Preserves transparency around rounded corners
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    setIsGenerating(false);
                    element.style.overflow = originalOverflow;
                });
            };

            // UI Component Helpers
            const InputLabel = ({children}) => <label className="block text-[10px] uppercase tracking-widest text-white/50 mb-1.5 font-semibold">{children}</label>;
            
            // Derived colors for header
            const headerTextColor = getContrastColor(theme.color);
            const headerSubTextColor = getContrastColor(theme.color) === '#ffffff' ? 'rgba(255,255,255,0.8)' : 'rgba(15, 23, 42, 0.7)';
            const logoBg = getContrastColor(theme.color) === '#ffffff' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';

            return (
                <div className="flex h-full flex-col md:flex-row relative">
                    
                    {/* === LEFT PANEL: EDITOR === */}
                    <div className={`w-full md:w-[400px] lg:w-[450px] backdrop-blur-xl bg-studio-900/80 border-r border-studio-border flex flex-col h-[calc(100%-60px)] md:h-full z-20 shadow-2xl transition-transform duration-500 ${activeTab === 'preview' ? 'hidden md:flex' : 'flex'}`}>
                        
                        {/* Header */}
                        <div className="p-6 border-b border-studio-border flex justify-between items-center bg-studio-900/50">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded bg-gradient-to-br from-pink-500 to-orange-400 flex items-center justify-center shadow-lg shadow-orange-500/20">
                                    <IconSparkle className="text-white" />
                                </div>
                                <h2 className="font-display font-bold text-xl tracking-tight text-white">INVOICER</h2>
                            </div>
                            
                            <div className="flex gap-2">
                                {profiles.length > 0 && (
                                    <select 
                                        className="text-xs bg-studio-700 border border-studio-border text-white rounded px-2 py-1.5 outline-none focus:border-white/30"
                                        value={selectedProfile}
                                        onChange={(e) => loadProfile(e.target.value)}
                                    >
                                        <option value="">Load Profile...</option>
                                        {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                )}
                                <button onClick={saveProfile} className="p-2 bg-studio-700 hover:bg-studio-600 text-white rounded border border-studio-border transition-colors" title="Save Profile">
                                    <IconSave />
                                </button>
                            </div>
                        </div>

                        {/* Form Content */}
                        <div className="flex-1 overflow-y-auto p-6 custom-scroll space-y-8 pb-24">
                            
                            {/* Design Section */}
                            <section className="animate-fade-in-up" style={{animationDelay: '0.1s'}}>
                                <div className="flex items-center gap-2 mb-4 text-orange-400">
                                    <IconPalette size={14} />
                                    <h3 className="text-xs font-bold uppercase tracking-widest">Aesthetics</h3>
                                </div>
                                <div className="p-4 bg-white/5 rounded-xl border border-white/5 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <InputLabel>Accent Color</InputLabel>
                                            <div className="h-10 w-full bg-black/20 rounded-lg border border-white/10 flex items-center px-2 relative overflow-hidden">
                                                <input type="color" className="absolute -top-2 -left-2 w-[200%] h-[200%] cursor-pointer opacity-0" 
                                                    value={theme.color} onChange={e => setTheme({...theme, color: e.target.value})} />
                                                <div className="w-full h-6 rounded flex items-center justify-center text-xs font-mono" style={{backgroundColor: theme.color, color: '#fff', textShadow: '0 1px 2px rgba(0,0,0,0.3)'}}>
                                                    {theme.color}
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <InputLabel>Corners</InputLabel>
                                            <select className="input-minimal w-full p-2 text-sm" value={theme.borderRadius} onChange={e => setTheme({...theme, borderRadius: e.target.value})}>
                                                <option value="0px">Sharp</option>
                                                <option value="0.25rem">Subtle</option>
                                                <option value="0.75rem">Soft</option>
                                                <option value="1.5rem">Round</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <InputLabel>Typography Style</InputLabel>
                                        <select className="input-minimal w-full p-2 text-sm" value={theme.font} onChange={e => setTheme({...theme, font: e.target.value})}>
                                            <option value="Plus Jakarta Sans">Modern Geometric (Jakarta)</option>
                                            <option value="Cormorant Garamond">Editorial Serif (Cormorant)</option>
                                            <option value="IBM Plex Mono">Technical Mono (IBM)</option>
                                        </select>
                                    </div>
                                </div>
                            </section>

                            {/* Meta Data */}
                            <section className="animate-fade-in-up" style={{animationDelay: '0.2s'}}>
                                <h3 className="text-xs font-bold uppercase tracking-widest text-white/40 mb-4">Invoice Details</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <InputLabel>Number</InputLabel>
                                        <input type="text" className="input-minimal w-full p-2.5 text-sm font-mono" value={meta.number} onChange={e => setMeta({...meta, number: e.target.value})} />
                                    </div>
                                    <div>
                                        <InputLabel>Logo</InputLabel>
                                        <label className="input-minimal w-full p-2 text-xs flex items-center justify-center cursor-pointer hover:bg-white/10 h-[42px]">
                                            <span className="truncate">{meta.logo ? 'Change Logo' : 'Upload Logo'}</span>
                                            <input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} />
                                        </label>
                                    </div>
                                    <div>
                                        <InputLabel>Issued</InputLabel>
                                        <input type="date" className="input-minimal w-full p-2.5 text-sm" value={meta.dateIssued} onChange={e => setMeta({...meta, dateIssued: e.target.value})} />
                                    </div>
                                    <div>
                                        <InputLabel>Due</InputLabel>
                                        <input type="date" className="input-minimal w-full p-2.5 text-sm" value={meta.dateDue} onChange={e => setMeta({...meta, dateDue: e.target.value})} />
                                    </div>
                                </div>
                            </section>

                            {/* Sender */}
                            <section className="animate-fade-in-up" style={{animationDelay: '0.3s'}}>
                                <div className="flex items-center gap-2 mb-4 text-white/40">
                                    <IconUser size={14} />
                                    <h3 className="text-xs font-bold uppercase tracking-widest">From</h3>
                                </div>
                                <div className="space-y-3">
                                    <input placeholder="Your Name" className="input-minimal w-full p-3 text-sm font-semibold" value={sender.name} onChange={e => setSender({...sender, name: e.target.value})} />
                                    <input placeholder="Title / Subtitle" className="input-minimal w-full p-3 text-sm" value={sender.subtitle} onChange={e => setSender({...sender, subtitle: e.target.value})} />
                                    <textarea placeholder="Address & Contact Info" rows="2" className="input-minimal w-full p-3 text-sm" value={sender.address} onChange={e => setSender({...sender, address: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <input placeholder="Email" className="input-minimal w-full p-3 text-sm" value={sender.email} onChange={e => setSender({...sender, email: e.target.value})} />
                                        <input placeholder="Phone" className="input-minimal w-full p-3 text-sm" value={sender.phone} onChange={e => setSender({...sender, phone: e.target.value})} />
                                    </div>
                                    <div className="pt-2">
                                        <InputLabel>Payment Instructions</InputLabel>
                                        <textarea placeholder="Bank details, Zelle, Checks..." rows="3" className="input-minimal w-full p-3 text-sm" value={sender.paymentInfo} onChange={e => setSender({...sender, paymentInfo: e.target.value})} />
                                    </div>
                                </div>
                            </section>

                            {/* Recipient */}
                            <section className="animate-fade-in-up" style={{animationDelay: '0.4s'}}>
                                <h3 className="text-xs font-bold uppercase tracking-widest text-white/40 mb-4">Bill To</h3>
                                <div className="space-y-3">
                                    <input placeholder="Client Company" className="input-minimal w-full p-3 text-sm font-semibold" value={recipient.company} onChange={e => setRecipient({...recipient, company: e.target.value})} />
                                    <input placeholder="Attention To" className="input-minimal w-full p-3 text-sm" value={recipient.attn} onChange={e => setRecipient({...recipient, attn: e.target.value})} />
                                    <textarea placeholder="Client Address" rows="2" className="input-minimal w-full p-3 text-sm" value={recipient.address} onChange={e => setRecipient({...recipient, address: e.target.value})} />
                                </div>
                            </section>

                            {/* Line Items */}
                            <section className="animate-fade-in-up" style={{animationDelay: '0.5s'}}>
                                <h3 className="text-xs font-bold uppercase tracking-widest text-white/40 mb-4">Line Items</h3>
                                <div className="space-y-4">
                                    {lineItems.map((item, index) => (
                                        <div key={item.id} className="p-4 bg-white/5 border border-white/5 rounded-xl group hover:bg-white/10 transition-colors relative">
                                            <button onClick={() => removeLineItem(item.id)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-opacity">
                                                <IconTrash size={14} />
                                            </button>
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="text-[10px] font-mono bg-white/10 px-1.5 py-0.5 rounded text-white/60">0{index + 1}</span>
                                            </div>
                                            <div className="space-y-3">
                                                <input 
                                                    placeholder="Description" 
                                                    className="bg-transparent border-b border-white/10 w-full pb-1 text-sm focus:outline-none focus:border-orange-400 transition-colors placeholder-white/30" 
                                                    value={item.description} 
                                                    onChange={e => handleLineItemChange(item.id, 'description', e.target.value)} 
                                                />
                                                <div className="grid grid-cols-3 gap-3">
                                                    <div>
                                                        <InputLabel>Date</InputLabel>
                                                        <input type="text" className="input-minimal w-full p-2 text-xs" value={item.date} onChange={e => handleLineItemChange(item.id, 'date', e.target.value)} />
                                                    </div>
                                                    <div>
                                                        <InputLabel>Rate</InputLabel>
                                                        <input type="number" className="input-minimal w-full p-2 text-xs" value={item.rate} onChange={e => handleLineItemChange(item.id, 'rate', parseFloat(e.target.value) || 0)} />
                                                    </div>
                                                    <div>
                                                        <InputLabel>Qty</InputLabel>
                                                        <input type="number" className="input-minimal w-full p-2 text-xs" value={item.quantity} onChange={e => handleLineItemChange(item.id, 'quantity', parseFloat(e.target.value) || 0)} />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={addLineItem} className="w-full py-3 border border-dashed border-white/20 hover:border-white/40 hover:bg-white/5 rounded-xl text-xs uppercase tracking-wider font-bold text-white/60 transition-all flex items-center justify-center gap-2">
                                        <IconPlus /> Add Item
                                    </button>
                                </div>
                            </section>

                            {/* Footer Notes */}
                            <section className="animate-fade-in-up" style={{animationDelay: '0.6s'}}>
                                <h3 className="text-xs font-bold uppercase tracking-widest text-white/40 mb-4">Footer Note</h3>
                                <textarea rows="2" className="input-minimal w-full p-3 text-sm" value={notes} onChange={e => setNotes(e.target.value)} />
                            </section>

                            {/* Attribution */}
                            <div className="pt-4 pb-8 text-center border-t border-white/5 animate-fade-in-up" style={{animationDelay: '0.7s'}}>
                                <p className="text-[10px] text-white/30 uppercase tracking-widest font-medium leading-relaxed">
                                    Invoicer | Â© 2025 <a href="https://centerforcooperativemedia.org/" target="_blank" rel="noopener noreferrer" className="text-white/50 hover:text-orange-400 transition-colors">Center for Cooperative Media</a>
                                    <br />
                                    Created by <a href="https://twitter.com/jsamditis" target="_blank" rel="noopener noreferrer" className="text-white/50 hover:text-orange-400 transition-colors">Joe Amditis</a>
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* === RIGHT PANEL: PREVIEW === */}
                    <div className={`w-full md:flex-1 flex-col h-[calc(100%-60px)] md:h-full relative ${activeTab === 'editor' ? 'hidden md:flex' : 'flex'}`}>
                        
                        {/* Toolbar */}
                        <div className="h-16 absolute top-0 right-0 left-0 z-30 flex justify-end items-center px-6 pointer-events-none">
                            <button 
                                onClick={handleDownload} 
                                disabled={isGenerating}
                                className="pointer-events-auto flex items-center gap-2 bg-white text-black hover:bg-gray-200 px-5 py-2.5 rounded-full shadow-xl shadow-black/20 text-xs font-bold uppercase tracking-wider transition-all transform hover:scale-105 disabled:opacity-70 disabled:scale-100"
                            >
                                {isGenerating ? 'Generating...' : <><IconDownload /> Download PDF</>}
                            </button>
                        </div>

                        {/* Preview Canvas */}
                        <div className="flex-1 overflow-auto p-4 md:p-12 flex justify-center custom-scroll relative">
                            
                            {/* THE INVOICE PAPER */}
                            <div 
                                id="invoice-preview-content" 
                                className="bg-white shadow-2xl w-full max-w-[800px] min-h-[800px] relative invoice-preview flex flex-col md:animate-fade-in-up"
                                style={{ 
                                    fontFamily: theme.font,
                                    borderRadius: theme.borderRadius,
                                    overflow: 'hidden',
                                    animationDelay: '0.2s'
                                }}
                            >
                                {/* Header */}
                                <header 
                                    className="p-10 flex justify-between items-start transition-colors duration-500 flex-col md:flex-row gap-6"
                                    style={{ backgroundColor: theme.color, color: headerTextColor }}
                                >
                                    <div className="flex flex-col gap-4 w-full">
                                        {meta.logo && (
                                            <img src={meta.logo} alt="Logo" className="h-16 w-auto object-contain self-start rounded p-2 backdrop-blur-sm" style={{backgroundColor: logoBg}} />
                                        )}
                                        <div>
                                            <h2 className="text-4xl font-bold tracking-tight mb-1 leading-none">{sender.name || 'Your Name'}</h2>
                                            <p className="text-sm font-medium tracking-wide" style={{color: headerSubTextColor}}>{sender.subtitle}</p>
                                        </div>
                                    </div>
                                    <div className="text-left md:text-right w-full">
                                        <h1 className="text-5xl font-thin tracking-wider uppercase opacity-90" style={{fontFamily: 'Syne, sans-serif'}}>Invoice</h1>
                                        <p className="mt-2 font-mono text-sm" style={{color: headerSubTextColor}}>{meta.number}</p>
                                    </div>
                                </header>

                                <div className="p-10 flex-1 flex flex-col text-slate-800">
                                    
                                    {/* Meta Grid */}
                                    <section className="grid grid-cols-1 md:grid-cols-2 gap-12 mb-16">
                                        
                                        {/* Bill From */}
                                        <div className="text-sm">
                                            <h3 className="font-bold text-slate-400 uppercase text-[10px] mb-4 tracking-[0.2em]">From</h3>
                                            <div className="space-y-1.5 text-slate-600">
                                                <p className="font-bold text-xl text-slate-900 mb-2">{sender.name || '[Your Name]'}</p>
                                                
                                                {sender.address.split('\n').map((line, i) => (
                                                    <p key={i} className="leading-relaxed">{line}</p>
                                                ))}

                                                {(sender.email || sender.phone) && (
                                                    <div className="pt-2 flex flex-col gap-1 opacity-80">
                                                        {sender.email && <span>{sender.email}</span>}
                                                        {sender.phone && <span>{sender.phone}</span>}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Details & Bill To */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div>
                                                <h3 className="font-bold text-slate-400 uppercase text-[10px] mb-4 tracking-[0.2em]">Details</h3>
                                                <div className="space-y-4 text-sm">
                                                    <div>
                                                        <span className="block text-[10px] text-slate-400 uppercase tracking-wider mb-1">Issued</span>
                                                        <span className="text-slate-800 font-medium">{meta.dateIssued}</span>
                                                    </div>
                                                    <div>
                                                        <span className="block text-[10px] text-slate-400 uppercase tracking-wider mb-1">Due</span>
                                                        <span className="text-slate-800 font-medium">{meta.dateDue}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div>
                                                <h3 className="font-bold text-slate-400 uppercase text-[10px] mb-4 tracking-[0.2em]">To</h3>
                                                <div className="text-sm text-slate-600">
                                                    <p className="font-bold text-slate-900 text-lg mb-1">{recipient.company || '[Company]'}</p>
                                                    {recipient.attn && <p className="mb-2">Attn: {recipient.attn}</p>}
                                                    {recipient.address && <p className="whitespace-pre-line leading-relaxed opacity-80">{recipient.address}</p>}
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    {/* Table */}
                                    <section className="mb-12">
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="border-b border-slate-200">
                                                    <th className="py-4 text-[10px] font-bold uppercase text-slate-400 tracking-widest w-1/2">Item</th>
                                                    <th className="py-4 text-[10px] font-bold uppercase text-slate-400 tracking-widest text-right hidden md:table-cell">Date</th>
                                                    <th className="py-4 text-[10px] font-bold uppercase text-slate-400 tracking-widest text-right">Rate</th>
                                                    <th className="py-4 text-[10px] font-bold uppercase text-slate-400 tracking-widest text-right">Qty</th>
                                                    <th className="py-4 text-[10px] font-bold uppercase text-slate-400 tracking-widest text-right">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm">
                                                {lineItems.map((item) => (
                                                    <tr key={item.id} className="border-b border-slate-100 group">
                                                        <td className="py-5 pr-4 align-top">
                                                            <p className="font-semibold text-slate-900 text-base">{item.description || 'Service Item'}</p>
                                                            <p className="text-xs text-slate-400 md:hidden mt-1 font-mono">{item.date}</p>
                                                        </td>
                                                        <td className="py-5 text-right text-slate-500 whitespace-nowrap align-top hidden md:table-cell font-mono text-xs">{item.date || '-'}</td>
                                                        <td className="py-5 text-right text-slate-500 align-top font-mono">${item.rate.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                                        <td className="py-5 text-right text-slate-500 align-top font-mono">{item.quantity}</td>
                                                        <td className="py-5 text-right font-bold text-slate-900 align-top font-mono">${(item.rate * item.quantity).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </section>

                                    {/* Footer Section */}
                                    <section className="flex flex-col md:flex-row gap-12 mt-auto">
                                        <div className="flex-1 order-2 md:order-1">
                                            {sender.paymentInfo && (
                                                <div className="mb-8">
                                                    <h3 className="font-bold text-slate-400 text-[10px] mb-3 tracking-widest uppercase">Payment Instructions</h3>
                                                    <p className="text-sm text-slate-600 whitespace-pre-wrap p-4 bg-slate-50 rounded border border-slate-100 leading-relaxed font-mono text-xs">{sender.paymentInfo}</p>
                                                </div>
                                            )}
                                            {notes && (
                                                <div>
                                                    <h3 className="font-bold text-slate-400 text-[10px] mb-2 tracking-widest uppercase">Notes</h3>
                                                    <p className="text-sm text-slate-500 italic whitespace-pre-wrap">{notes}</p>
                                                </div>
                                            )}
                                        </div>

                                        <div className="w-full md:w-[280px] order-1 md:order-2">
                                            <div className="bg-slate-900 text-white p-8 rounded-lg shadow-xl relative overflow-hidden">
                                                {/* Subtle decorative circle */}
                                                <div className="absolute -top-10 -right-10 w-32 h-32 bg-white/5 rounded-full blur-2xl"></div>
                                                
                                                <div className="flex justify-between items-center mb-4 text-sm text-slate-400">
                                                    <span>Subtotal</span>
                                                    <span className="font-mono text-white">${calculateTotal().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                                </div>
                                                <div className="flex justify-between items-center pt-4 border-t border-white/10">
                                                    <span className="font-bold text-lg">Total</span>
                                                    <span className="font-bold text-2xl font-mono">${calculateTotal().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                    
                                    <footer className="mt-16 pt-8 border-t border-slate-100 text-center text-[10px] text-slate-300 uppercase tracking-widest order-3">
                                        <p>Generated by Invoice Studio</p>
                                    </footer>

                                </div>
                            </div>
                        </div>
                    </div>

                    {/* === MOBILE TAB BAR === */}
                    <div className="md:hidden fixed bottom-0 left-0 w-full bg-studio-900 border-t border-studio-border z-50 flex justify-around items-center h-[60px] shadow-2xl">
                        <button 
                            onClick={() => setActiveTab('editor')} 
                            className={`flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition-colors ${activeTab === 'editor' ? 'text-white' : 'text-white/40'}`}
                        >
                            <IconEdit size={18} />
                            <span className="text-[10px] font-bold uppercase tracking-widest">Editor</span>
                        </button>
                        <button 
                            onClick={() => setActiveTab('preview')} 
                            className={`flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition-colors ${activeTab === 'preview' ? 'text-white' : 'text-white/40'}`}
                        >
                            <IconEye size={18} />
                            <span className="text-[10px] font-bold uppercase tracking-widest">Preview</span>
                        </button>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InvoiceTool />);
    </script>
</body>
</html>